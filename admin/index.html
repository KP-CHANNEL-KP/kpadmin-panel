export default {
  async fetch(request, env, ctx) {
    const url = new URL(request.url);
    let path = url.pathname;

    // Route base /kpvip/ ကို ဖြတ်ပေး
    const base = "/kpvip";
    if (path.startsWith(base)) {
      path = path.slice(base.length); // "/kpvip/create.php" -> "/create.php"
      if (path === "") path = "/";
    }

    // CORS simple
    if (request.method === "OPTIONS") {
      return new Response(null, {
        status: 204,
        headers: corsHeaders(),
      });
    }

    try {
      // --------- Admin-only routes ---------
      if (request.method === "POST" && path === "/create.php") {
        await requireAdminOrThrow(request, env);
        return await handleCreate(request, env);
      }

      if (request.method === "POST" && path === "/edit.php") {
        await requireAdminOrThrow(request, env);
        return await handleEdit(request, env);
      }

      if (request.method === "POST" && path === "/delete.php") {
        // Admin panel delete (x-admin-secret) **or** App auto-delete (Authorization)
        const isAdmin = await checkAdmin(request, env);
        const auth = request.headers.get("Authorization") || "";
        const isAppDelete = auth === "N4VPN-MinKhant";

        if (!isAdmin && !isAppDelete) {
          return json({ status: "error", message: "Unauthorized" }, 401);
        }
        return await handleDelete(request, env, isAppDelete);
      }

      if (request.method === "POST" && path === "/list.php") {
        await requireAdminOrThrow(request, env);
        return await handleList(env);
      }

      // --------- App routes (no admin) ---------
      if (request.method === "POST" && path === "/login.php") {
        return await handleLogin(request, env);
      }

      if (request.method === "POST" && path === "/user_exist.php") {
        return await handleUserExist(request, env);
      }

      // --------- Default ---------
      return json({ status: "error", message: "Not found", path, method: request.method }, 404);
    } catch (e) {
      return json(
        { status: "error", message: e.message || "Internal error" },
        500
      );
    }
  },
};

/* ---------------------- Helpers ---------------------- */

function corsHeaders(extra = {}) {
  return {
    "Access-Control-Allow-Origin": "*",
    "Access-Control-Allow-Methods": "GET,POST,OPTIONS",
    "Access-Control-Allow-Headers": "Content-Type,Authorization,x-admin-secret",
    ...extra,
  };
}

function json(obj, status = 200) {
  return new Response(JSON.stringify(obj), {
    status,
    headers: {
      "Content-Type": "application/json; charset=utf-8",
      ...corsHeaders(),
    },
  });
}

// Admin check: x-admin-secret **or** Authorization header
async function checkAdmin(request, env) {
  const secret = env.ADMIN_SECRET;
  if (!secret) return false;

  const h = request.headers;
  const x = h.get("x-admin-secret") || "";
  const auth = h.get("Authorization") || "";

  if (x === secret) return true;
  if (auth === secret) return true;
  if (auth === `Bearer ${secret}`) return true;

  return false;
}

async function requireAdminOrThrow(request, env) {
  const ok = await checkAdmin(request, env);
  if (!ok) {
    throw new Error("Unauthorized");
  }
}

// form-data (x-www-form-urlencoded)
async function getFormData(request) {
  const text = await request.text();
  return new URLSearchParams(text);
}

// ဖိုင်တစ်ခုစီကို KV ထဲမှာ JSON နဲ့သိမ်းမယ်
async function getUser(env, username) {
  if (!username) return null;
  const raw = await env.USERS_KV.get(username);
  if (!raw) return null;
  try {
    return JSON.parse(raw);
  } catch {
    return null;
  }
}

async function putUser(env, username, data) {
  const value = JSON.stringify(data);
  await env.USERS_KV.put(username, value);
}

async function deleteUser(env, username) {
  await env.USERS_KV.delete(username);
}

/* ---------------------- Handlers ---------------------- */

// Admin create user
async function handleCreate(request, env) {
  const form = await getFormData(request);
  const username = (form.get("username") || "").trim();
  const password = (form.get("password") || "").trim();
  const daysStr = (form.get("days") || "").trim();

  if (!username || !password || !daysStr) {
    return json({ status: "error", message: "missing_fields" }, 400);
  }

  const days = Number(daysStr) || 0;
  const now = Math.floor(Date.now() / 1000);
  const expireAt = now + days * 24 * 60 * 60;

  const exist = await getUser(env, username);
  const createdAt = exist?.createdAt || now;

  const data = {
    username,
    password,
    createdAt,
    expireAt,
    device_id: exist?.device_id || null,
  };

  await putUser(env, username, data);

  return json({ status: "ok", message: "User created", username, expireAt });
}

// Admin renew / App re-upload (device_id + expired_date)
async function handleEdit(request, env) {
  const form = await getFormData(request);
  const username = (form.get("username") || "").trim();

  if (!username) {
    return json({ status: "error", message: "missing_username" }, 400);
  }

  const u = await getUser(env, username);
  if (!u) {
    return json({ status: "error", message: "user_not_found" }, 404);
  }

  const daysStr = (form.get("days") || "").trim();
  const expiredDateStr = (form.get("expired_date") || "").trim();
  const deviceId = (form.get("device_id") || "").trim();

  const now = Math.floor(Date.now() / 1000);
  let expireAt = u.expireAt || now;

  if (daysStr) {
    const days = Number(daysStr) || 0;
    expireAt = now + days * 24 * 60 * 60;
  } else if (expiredDateStr) {
    // App က millis နဲ့ပို့တာကို seconds ထဲပြောင်းဆဲ
    const ms = Number(expiredDateStr) || 0;
    expireAt = Math.floor(ms / 1000);
  }

  if (deviceId) {
    u.device_id = deviceId;
  }

  u.expireAt = expireAt;
  await putUser(env, username, u);

  return json({ status: "ok", message: "updated", username, expireAt });
}

// Admin / App delete
async function handleDelete(request, env, isAppDelete) {
  const form = await getFormData(request);
  const username = isAppDelete
    ? (form.get("usernameToDelete") || "").trim()
    : (form.get("username") || "").trim();

  if (!username) {
    return json({ status: "error", message: "missing_username" }, 400);
  }

  await deleteUser(env, username);
  return json({ status: "ok", message: "deleted", username });
}

// Admin list users
async function handleList(env) {
  const list = await env.USERS_KV.list();
  const users = [];

  for (const k of list.keys) {
    const u = await getUser(env, k.name);
    if (!u) continue;
    users.push({
      username: u.username || k.name,
      createdAt: u.createdAt || null,
      expireAt: u.expireAt || null,
    });
  }

  return json({ status: "ok", users });
}

// App login
async function handleLogin(request, env) {
  const form = await getFormData(request);
  const username = (form.get("username") || "").trim();
  const password = (form.get("password") || "").trim();

  if (!username || !password) {
    return json({ status: "error", message: "missing_fields" }, 400);
  }

  const u = await getUser(env, username);
  if (!u) {
    return json({ status: "user_not_found", message: "User not found" });
  }

  if (u.password !== password) {
    return json({ status: "wrong_password", message: "Wrong password" });
  }

  const now = Math.floor(Date.now() / 1000);
  if (!u.expireAt || u.expireAt < now) {
    return json({ status: "expired", message: "Expired" });
  }

  const remainingSec = u.expireAt - now;
  const remainingDays = Math.max(1, Math.floor(remainingSec / (24 * 60 * 60)));

  // APK သဘောတရားကိုလိုက်ပြီး "login" နဲ့ expired_date(days) ပို့မယ်
  return json({
    status: "login",
    user: username,
    expired_date: String(remainingDays),
  });
}

// App + Panel user_exist
async function handleUserExist(request, env) {
  const form = await getFormData(request);
  const username = (form.get("username") || "").trim();

  if (!username) {
    return json({ status: "error", message: "missing_username" }, 400);
  }

  const u = await getUser(env, username);
  if (!u) {
    // APK မှာ status != "success" ဆိုရင် local data ဖျက်တာမို့
    return json({ status: "error", message: "user_not_found" });
  }

  return json({
    status: "success",
    user: username,
    expireAt: u.expireAt || null,
    createdAt: u.createdAt || null,
  });
}
