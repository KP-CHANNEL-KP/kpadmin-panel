// ---------- Admin HTML (index.html) ----------
const ADMIN_HTML = `<!DOCTYPE html>
<html lang="my">
<head>
  <meta charset="UTF-8">
  <title>KP VIP Admin Panel</title>
  <style>
    body {
      font-family: sans-serif;
      max-width: 900px;
      margin: 20px auto;
      padding: 0 10px;
    }
    h1 { text-align: center; }
    .card {
      border: 1px solid #ccc;
      border-radius: 6px;
      padding: 15px;
      margin-bottom: 20px;
    }
    label { display: block; margin-top: 8px; }
    input {
      width: 100%;
      padding: 6px;
      margin-top: 4px;
      box-sizing: border-box;
    }
    button {
      margin-top: 10px;
      padding: 8px 12px;
      cursor: pointer;
    }
    .row {
      display: flex;
      gap: 20px;
    }
    .row .card {
      flex: 1;
    }
    .log {
      font-size: 12px;
      background: #f5f5f5;
      padding: 10px;
      white-space: pre-wrap;
      max-height: 250px;
      overflow-y: auto;
    }
    #panel { display: none; }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 10px;
      font-size: 13px;
    }
    th, td {
      border: 1px solid #ddd;
      padding: 4px 6px;
      text-align: left;
    }
    th {
      background: #eee;
    }
  </style>
</head>
<body>
  <h1>KP VIP Admin Panel</h1>

  <div class="card" id="loginCard">
    <h2>Admin Login</h2>
    <p>Cloudflare Worker ထဲမှာ သတ်ထားတဲ့ <code>ADMIN_SECRET</code> ကို ဒီမှာ ထည့်ရပါမယ်။</p>
    <label>Admin Secret
      <input id="adminSecret" type="password" placeholder="e.g. myadmin123">
    </label>
    <button id="btnAdminLogin">Login</button>
    <p id="loginStatus"></p>
  </div>

  <div id="panel">
    <div class="row">
      <div class="card">
        <h2>အသစ် User ဖန်တီးမယ်</h2>
        <label>Username
          <input id="c_username" placeholder="user1">
        </label>
        <label>Password
          <input id="c_password" placeholder="123456">
        </label>
        <label>Days (Expire အထိ)
          <input id="c_days" type="number" value="30">
        </label>
        <button id="btnCreate">Create User</button>
      </div>

      <div class="card">
        <h2>User Renew (နေ့ထပ်တိုး)</h2>
        <label>Username
          <input id="e_username">
        </label>
        <label>Extra Days
          <input id="e_days" type="number" value="30">
        </label>
        <button id="btnEdit">Renew / Update</button>

        <h2 style="margin-top: 20px;">User ဖျက်မယ်</h2>
        <label>Username
          <input id="d_username">
        </label>
        <button id="btnDelete">Delete User</button>
      </div>
    </div>

    <div class="card">
      <h2>User ရှိ/မရှိ စစ်မယ်</h2>
      <label>Username
        <input id="q_username">
      </label>
      <button id="btnCheck">Check User</button>
      <pre id="userInfo" class="log"></pre>
    </div>

    <div class="card">
      <h2>User List အားလုံးကြည့်မယ်</h2>
      <button id="btnList">Load Users</button>
      <div id="userList"></div>
    </div>

    <div class="card">
      <h2>Log</h2>
      <pre id="log" class="log"></pre>
    </div>
  </div>

  <script>
    // မင်း Worker API base URL
    const API_BASE = "https://vpnadmin.kpwork.qzz.io/kpvip";

    function log(msg) {
      const el = document.getElementById("log");
      el.textContent += msg + "\\n";
      el.scrollTop = el.scrollHeight;
    }

    function setLoggedIn(flag) {
      document.getElementById("panel").style.display = flag ? "block" : "none";
    }

    function getAdminSecret() {
      return localStorage.getItem("ADMIN_SECRET") || "";
    }

    function saveAdminSecret(secret) {
      localStorage.setItem("ADMIN_SECRET", secret);
    }

    // Admin Login button
    document.getElementById("btnAdminLogin").onclick = () => {
      const secret = document.getElementById("adminSecret").value.trim();
      const statusEl = document.getElementById("loginStatus");
      if (!secret) {
        statusEl.textContent = "Secret မထည့်ရသေးဘူး";
        return;
      }
      saveAdminSecret(secret);
      statusEl.textContent = "Secret သိမ်းပြီး ✔ Admin panel ထဲသွားလို့ရပြီ";
      setLoggedIn(true);
      log("Admin login OK (local only, Worker ဘက်မှာ header နဲ့ verify လုပ်မယ်)");
    };

    async function apiPost(path, body) {
      const secret = getAdminSecret();
      if (!secret) {
        alert("Admin secret မသတ်ထားသေးဘူး");
        return null;
      }
      const url = API_BASE + path;
      const res = await fetch(url, {
        method: "POST",
        headers: {
          "Content-Type": "application/x-www-form-urlencoded; charset=UTF-8",
          "x-admin-secret": secret
        },
        body: new URLSearchParams(body)
      });
      let data;
      try {
        data = await res.json();
      } catch (e) {
        data = { status: "error", message: "Invalid JSON", raw: await res.text() };
      }
      log(path + " => " + JSON.stringify(data));
      return data;
    }

    // Create user
    document.getElementById("btnCreate").onclick = async () => {
      const username = document.getElementById("c_username").value.trim();
      const password = document.getElementById("c_password").value.trim();
      const days = document.getElementById("c_days").value.trim();

      if (!username || !password || !days) {
        alert("username / password / days သုံးခုလုံး ဖြည့်ပေးပါ");
        return;
      }

      const data = await apiPost("/create.php", {
        username: username,
        password: password,
        days: days
      });

      if (data && data.status === "ok") {
        alert("User ဖန်တီးပြီး: " + username);
      } else if (data) {
        alert("Create Fail: " + (data.message || "unknown error"));
      }
    };

    // Renew user
    document.getElementById("btnEdit").onclick = async () => {
      const username = document.getElementById("e_username").value.trim();
      const days = document.getElementById("e_days").value.trim();

      if (!username || !days) {
        alert("username / days ဖြည့်ပါ");
        return;
      }

      const data = await apiPost("/edit.php", { username: username, days: days });
      if (data && data.status === "ok") {
        alert("User renewed: " + username);
      } else if (data) {
        alert("Renew Fail: " + (data.message || "unknown error"));
      }
    };

    // Delete user
    document.getElementById("btnDelete").onclick = async () => {
      const username = document.getElementById("d_username").value.trim();
      if (!username) {
        alert("username ဖြည့်ပါ");
        return;
      }
      const ok = confirm("User " + username + " ကို တကယ်ဖျက်မလား?");
      if (!ok) return;

      const data = await apiPost("/delete.php", { username: username });
      if (data && data.status === "ok") {
        alert("User deleted: " + username);
      } else if (data) {
        alert("Delete Fail: " + (data.message || "unknown error"));
      }
    };

    // Check user
    document.getElementById("btnCheck").onclick = async () => {
      const username = document.getElementById("q_username").value.trim();
      if (!username) {
        alert("username ဖြည့်ပါ");
        return;
      }
      const data = await apiPost("/user_exist.php", { username: username });
      const el = document.getElementById("userInfo");
      el.textContent = JSON.stringify(data, null, 2);
    };

    // List users
    document.getElementById("btnList").onclick = async () => {
      const secret = getAdminSecret();
      if (!secret) {
        alert("Admin secret မသတ်ထားသေးဘူး");
        return;
      }
      const url = API_BASE + "/list.php";
      const res = await fetch(url, {
        method: "POST",
        headers: {
          "x-admin-secret": secret
        }
      });
      let data;
      try {
        data = await res.json();
      } catch (e) {
        data = { status: "error", message: "Invalid JSON", raw: await res.text() };
      }
      log("/list.php => " + JSON.stringify(data));

      const container = document.getElementById("userList");
      container.innerHTML = "";
      if (!data || data.status !== "ok") {
        container.textContent = "Load fail: " + (data && data.message);
        return;
      }

      const users = data.users || [];
      if (!users.length) {
        container.textContent = "User မရှိသေးဘူး";
        return;
      }

      const table = document.createElement("table");
      const thead = document.createElement("thead");
      thead.innerHTML = "<tr><th>Username</th><th>Created</th><th>Expire</th></tr>";
      table.appendChild(thead);
      const tbody = document.createElement("tbody");
      for (const u of users) {
        const tr = document.createElement("tr");
        const created = u.createdAt ? new Date(u.createdAt * 1000).toLocaleString() : "";
        const expire = u.expireAt ? new Date(u.expireAt * 1000).toLocaleString() : "";
        tr.innerHTML = "<td>" + u.username + "</td><td>" + created + "</td><td>" + expire + "</td>";
        tbody.appendChild(tr);
      }
      table.appendChild(tbody);
      container.appendChild(table);
    };

    // auto show panel if secret already saved
    window.addEventListener("load", () => {
      if (getAdminSecret()) {
        setLoggedIn(true);
        log("Loaded with existing admin secret");
      }
    });
  </script>
</body>
</html>`;


  /**
 * ====================================
 * HELPER FUNCTIONS (MOCK/PLACEHOLDER)
 * ====================================
 * These functions are assumed to be defined elsewhere in your project
 * or must be implemented for a real Cloudflare Worker environment.
 */

// Placeholder for a function to return a JSON Response
function json(data, status = 200) {
  return new Response(JSON.stringify(data), {
    status: status,
    headers: {
      "Content-Type": "application/json",
    },
  });
}

// Placeholder for getting form data (e.g., from a request body)
async function getFormData(request) {
  try {
    // Assuming the request body is form-data or JSON
    const contentType = request.headers.get("Content-Type") || "";
    if (contentType.includes("application/json")) {
      const data = await request.json();
      // Simple way to convert JSON object to a FormData-like structure for existing logic
      const form = new Map();
      for (const [key, value] of Object.entries(data)) {
        form.set(key, String(value));
      }
      return form;
    } else if (contentType.includes("application/x-www-form-urlencoded") || contentType.includes("multipart/form-data")) {
      return await request.formData();
    }
  } catch (error) {
    // Handle cases where body parsing fails
    console.error("Error parsing form data:", error);
    return new Map();
  }
}

// Placeholder to get user data from KV
async function getUser(env, username) {
  const userString = await env.USERS_KV.get(username);
  if (!userString) return null;
  try {
    return JSON.parse(userString);
  } catch (error) {
    console.error(`Error parsing user data for ${username}:`, error);
    return null;
  }
}

// Placeholder to save user data to KV
async function putUser(env, username, userObject) {
  // Ensure the object has necessary fields before stringifying
  if (!userObject.username) userObject.username = username;
  await env.USERS_KV.put(username, JSON.stringify(userObject));
}

// Placeholder to delete user data from KV
async function deleteUser(env, username) {
  await env.USERS_KV.delete(username);
}

/**
 * ====================================
 * CORE HANDLER FUNCTIONS
 * ====================================
 */

/**
 * Handles editing a user's expiration date or device ID.
 */
async function handleEdit(request, env) {
  const form = await getFormData(request);
  const username = (form.get("username") || "").trim();

  if (!username) {
    return json({ status: "error", message: "missing_username" }, 400);
  }

  const u = await getUser(env, username);
  if (!u) {
    return json({ status: "error", message: "user_not_found" }, 404);
  }

  const daysStr = (form.get("days") || "").trim();
  const expiredDateStr = (form.get("expired_date") || "").trim(); // Unix timestamp in milliseconds
  const deviceId = (form.get("device_id") || "").trim();

  const now = Math.floor(Date.now() / 1000); // Current time in seconds
  let expireAt = u.expireAt || now; // Initialize with current expiration or 'now'

  // --- Expiration Date Logic ---
  if (daysStr) {
    const days = Number(daysStr);
    if (isNaN(days) || days < 0) {
        return json({ status: "error", message: "invalid_days_value" }, 400);
    }
    // Set expiration relative to now
    expireAt = now + days * 24 * 60 * 60;
  } else if (expiredDateStr) {
    // expiredDateStr is expected to be a Unix timestamp in milliseconds
    const ms = Number(expiredDateStr);
    if (isNaN(ms) || ms < 0) {
        return json({ status: "error", message: "invalid_expired_date_value" }, 400);
    }
    // Convert milliseconds to seconds
    expireAt = Math.floor(ms / 1000);
  }

  // --- Device ID Logic ---
  if (deviceId) {
    u.device_id = deviceId;
  }

  // Update user object and save
  u.expireAt = expireAt;
  await putUser(env, username, u);

  // Return the updated expiration time (in seconds)
  return json({ status: "ok", message: "updated", username, expireAt });
}

/**
 * Handles deleting a user.
 * @param {boolean} isAppDelete - Flag to determine key name (e.g., from an Admin panel).
 */
async function handleDelete(request, env, isAppDelete) {
  const form = await getFormData(request);
  
  // Use 'usernameToDelete' if isAppDelete is true, otherwise use 'username'
  const username = isAppDelete
    ? (form.get("usernameToDelete") || "").trim()
    : (form.get("username") || "").trim();

  if (!username) {
    return json({ status: "error", message: "missing_username" }, 400);
  }

  await deleteUser(env, username);
  
  // Note: KV delete is idempotent, so we return success even if the user didn't exist.
  return json({ status: "ok", message: "deleted", username });
}

/**
 * Handles listing all users from the KV store.
 */
async function handleList(env) {
  const list = await env.USERS_KV.list();
  const userKeys = list.keys.map(k => k.name);

  // Fetch all user objects in parallel for efficiency
  const userPromises = userKeys.map(key => getUser(env, key));
  const userObjects = await Promise.all(userPromises);

  const users = userObjects
    .filter(u => u !== null) // Filter out users that failed to load/parse
    .map(u => ({
      username: u.username,
      createdAt: u.createdAt || null,
      expireAt: u.expireAt || null,
      // SECURITY NOTE: DO NOT expose the password field here in a real application!
    }));

  return json({ status: "ok", users });
}

/**
 * Handles user login and checks expiration.
 */
async function handleLogin(request, env) {
  const form = await getFormData(request);
  const username = (form.get("username") || "").trim();
  const password = (form.get("password") || "").trim();

  if (!username || !password) {
    return json({ status: "error", message: "missing_fields", details: "Username or password missing" }, 400);
  }

  const u = await getUser(env, username);
  if (!u) {
    // Return a generic error message for security (e.g., "Invalid credentials") 
    // instead of "User not found" to prevent user enumeration attacks.
    return json({ status: "error", message: "invalid_credentials" }, 401); 
  }

  // ⚠️ SECURITY ALERT: Storing/checking plain passwords like this is INSECURE.
  // Use a strong, one-way hashing algorithm (like Argon2 or bcrypt) for production.
  if (u.password !== password) {
    return json({ status: "error", message: "invalid_credentials" }, 401); 
  }

  const now = Math.floor(Date.now() / 1000); // Current time in seconds
  
  if (!u.expireAt || u.expireAt < now) {
    return json({ status: "error", message: "expired_account", details: "Account has expired" }, 403);
  }

  // Calculate remaining days (at least 1 day if not expired)
  const remainingSec = u.expireAt - now;
  // Use Math.ceil to ensure partial days are counted as 1 (better for user experience)
  const remainingDays = Math.ceil(remainingSec / (24 * 60 * 60));

  return json({
    status: "ok", // Changed from "login" to "ok" for better status consistency
    message: "login_successful",
    username: username,
    remaining_days: String(remainingDays), // Keep as string if API consumers expect it
    expireAt: u.expireAt, // Optionally return the exact expiration timestamp
  });
}

/**
 * Handles checking if a user exists and returns their details.
 */
async function handleUserExist(request, env) {
  const form = await getFormData(request);
  const username = (form.get("username") || "").trim();

  if (!username) {
    return json({ status: "error", message: "missing_username" }, 400);
  }

  const u = await getUser(env, username);
  if (!u) {
    return json({ status: "error", message: "user_not_found" }, 404);
  }

  return json({
    status: "ok",
    username: username,
    expireAt: u.expireAt || null, // Unix timestamp in seconds
    createdAt: u.createdAt || null, // Unix timestamp in seconds
    // SECURITY NOTE: DO NOT expose the password field here!
  });
}

// Export functions if this is a module/worker
// export { handleEdit, handleDelete, handleList, handleLogin, handleUserExist };
