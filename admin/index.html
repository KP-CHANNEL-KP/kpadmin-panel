<!DOCTYPE html>
<html lang="my">
<head>
  <meta charset="UTF-8" />
  <title>KP VIP Admin Panel</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root {
      --primary: #2563eb;
      --primary-soft: #dbeafe;
      --danger: #ef4444;
      --bg: #0f172a;
      --card-bg: #0b1220;
      --border: #1f2937;
      --text-main: #e5e7eb;
      --text-muted: #9ca3af;
    }

    * {
      box-sizing: border-box;
    }

    body {
      margin: 0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: radial-gradient(circle at top, #1d2538, #020617 60%);
      color: var(--text-main);
      min-height: 100vh;
    }

    .wrapper {
      max-width: 1100px;
      margin: 0 auto;
      padding: 20px 16px 40px;
    }

    .topbar {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 12px;
      margin-bottom: 20px;
    }

    .title-block h1 {
      font-size: 24px;
      margin: 0;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .badge {
      font-size: 11px;
      padding: 2px 8px;
      border-radius: 999px;
      background: rgba(34, 197, 94, 0.15);
      border: 1px solid rgba(34, 197, 94, 0.4);
      color: #bbf7d0;
    }

    .subtitle {
      margin: 4px 0 0;
      font-size: 13px;
      color: var(--text-muted);
    }

    .top-actions {
      display: flex;
      align-items: center;
      gap: 8px;
      flex-wrap: wrap;
    }

    .small-tag {
      font-size: 12px;
      padding: 4px 8px;
      border-radius: 999px;
      border: 1px solid var(--border);
      color: var(--text-muted);
    }

    .card {
      background: var(--card-bg);
      border-radius: 14px;
      border: 1px solid var(--border);
      padding: 16px 16px 14px;
      box-shadow: 0 12px 30px rgba(15, 23, 42, 0.8);
    }

    .card h2 {
      margin: 0 0 6px;
      font-size: 16px;
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .card small {
      font-size: 12px;
      color: var(--text-muted);
    }

    label {
      display: block;
      margin-top: 10px;
      font-size: 13px;
    }

    .input {
      width: 100%;
      margin-top: 4px;
      padding: 7px 9px;
      border-radius: 8px;
      border: 1px solid #1f2937;
      background: #020617;
      color: var(--text-main);
      font-size: 13px;
      outline: none;
      transition: border 0.15s, box-shadow 0.15s, background 0.15s;
    }

    .input:focus {
      border-color: #3b82f6;
      box-shadow: 0 0 0 1px rgba(59, 130, 246, 0.4);
      background: #020617;
    }

    .row {
      display: flex;
      gap: 16px;
      flex-wrap: wrap;
      margin-bottom: 16px;
    }

    .row .card {
      flex: 1 1 260px;
    }

    .btn {
      margin-top: 12px;
      padding: 7px 12px;
      font-size: 13px;
      border-radius: 999px;
      border: 1px solid transparent;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 6px;
      background: linear-gradient(135deg, #2563eb, #22c55e);
      color: white;
      font-weight: 500;
      box-shadow: 0 10px 25px rgba(37, 99, 235, 0.35);
      transition: transform 0.12s, box-shadow 0.12s, opacity 0.1s;
    }

    .btn:hover {
      transform: translateY(-1px);
      box-shadow: 0 14px 30px rgba(37, 99, 235, 0.5);
    }

    .btn:active {
      transform: translateY(0);
      opacity: 0.9;
      box-shadow: 0 10px 20px rgba(37, 99, 235, 0.35);
    }

    .btn-secondary {
      background: transparent;
      border-color: #374151;
      color: var(--text-main);
      box-shadow: none;
    }

    .btn-secondary:hover {
      background: #020617;
      transform: none;
      box-shadow: 0 0 0 1px #374151;
    }

    .btn-danger {
      background: transparent;
      border-color: rgba(239, 68, 68, 0.7);
      color: #fecaca;
      box-shadow: 0 0 0 1px rgba(239, 68, 68, 0.5);
    }

    .btn-danger:hover {
      background: rgba(239, 68, 68, 0.15);
    }

    .pill-field {
      display: flex;
      gap: 8px;
      align-items: center;
      margin-top: 8px;
      font-size: 12px;
      color: var(--text-muted);
    }

    .pill-field span {
      padding: 1px 7px;
      border-radius: 999px;
      border: 1px solid #374151;
    }

    .user-panel-header {
      display: flex;
      justify-content: space-between;
      align-items: flex-end;
      gap: 8px;
      margin-bottom: 6px;
    }

    .user-panel-header h2 {
      margin: 0;
    }

    .filter-row {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
      margin-bottom: 10px;
    }

    .filter-row .input {
      max-width: 220px;
    }

    .status-chip {
      display: inline-flex;
      align-items: center;
      gap: 4px;
      font-size: 11px;
      padding: 2px 7px;
      border-radius: 999px;
      border: 1px solid rgba(34, 197, 94, 0.6);
      background: rgba(22, 163, 74, 0.12);
      color: #bbf7d0;
    }

    .status-chip.expired {
      border-color: rgba(239, 68, 68, 0.7);
      background: rgba(239, 68, 68, 0.12);
      color: #fecaca;
    }

    .status-chip span {
      opacity: 0.9;
    }

    .status-dot {
      width: 6px;
      height: 6px;
      border-radius: 999px;
      background: #22c55e;
    }

    .status-dot.expired {
      background: #ef4444;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 13px;
      margin-top: 4px;
    }

    th, td {
      padding: 6px 6px;
      border-bottom: 1px solid #111827;
      text-align: left;
      white-space: nowrap;
    }

    th {
      font-size: 12px;
      color: #9ca3af;
      text-transform: uppercase;
      letter-spacing: 0.04em;
      background: #020617;
      position: sticky;
      top: 0;
      z-index: 1;
    }

    tbody tr:hover td {
      background: rgba(15, 23, 42, 0.8);
    }

    .username-col {
      font-weight: 500;
      font-size: 13px;
    }

    .mono {
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      font-size: 12px;
    }

    .dim {
      color: var(--text-muted);
      font-size: 12px;
    }

    .user-table-wrapper {
      max-height: 360px;
      overflow: auto;
      margin-top: 4px;
      border-radius: 10px;
      border: 1px solid #111827;
      background: rgba(15, 23, 42, 0.85);
    }

    .empty {
      padding: 12px 4px;
      font-size: 13px;
      color: var(--text-muted);
    }

    .tag {
      font-size: 11px;
      padding: 2px 6px;
      border-radius: 999px;
      border: 1px solid #1f2937;
      background: #020617;
      color: #9ca3af;
    }

    @media (max-width: 640px) {
      .topbar {
        flex-direction: column;
        align-items: flex-start;
      }
      .user-table-wrapper {
        max-height: 260px;
      }
    }
  </style>
</head>
<body>
  <div class="wrapper">
    <div class="topbar">
      <div class="title-block">
        <h1>
          KP VIP Admin
          <span class="badge">Premium</span>
        </h1>
        <p class="subtitle">Username / Password á€€á€­á€¯ á€¡á€œá€½á€šá€ºá€á€€á€° á€…á€®á€™á€¶á€á€”á€·á€ºá€á€½á€²á€–á€­á€¯á€· Panel á€–á€¼á€…á€ºá€•á€«á€á€šá€ºá‹</p>
      </div>
      <div class="top-actions">
        <button id="btnAdminSecret" class="btn btn-secondary" style="margin-top:0;">
          ğŸ” Admin Login
        </button>
        <span class="small-tag" id="adminStatus">ğŸ”’ Admin: Locked</span>
        <span class="small-tag">API: <b>/kpvip/*.php</b></span>
      </div>
    </div>

    <!-- Top row: Create + Renew/Delete -->
    <div class="row">
      <!-- Create -->
      <div class="card">
        <h2>á€¡á€á€…á€º User á€–á€”á€ºá€á€®á€¸á€™á€šá€º</h2>
        <small>Username, Password, Expire Days á€á€á€ºá€™á€¾á€á€ºá€•á€¼á€®á€¸ VIP User á€–á€”á€ºá€á€®á€¸á€•á€«á‹ (1DV â€“ Login á€á€„á€ºá€á€²á€·á€”á€±á€·á€€á€… Expire á€…á€•á€«á€™á€šá€º)</small>

        <label>Username
          <input id="c_username" class="input" placeholder="eg. kp001" />
        </label>
        <label>Password
          <input id="c_password" class="input" placeholder="eg. 123456" />
        </label>
        <label>Days (Expire á€¡á€‘á€­)
          <input id="c_days" class="input" type="number" value="30" min="1" />
        </label>

        <div class="pill-field">
          <span>á€–á€”á€ºá€á€®á€¸á€á€½á€¬á€¸á€á€²á€· User á€€á€­á€¯ List á€‘á€²á€™á€¾á€¬ â€‹á€€á€¼á€Šá€ºá€·á€›á€›á€¾á€„á€ºá€¸á€¡á€±á€¬á€„á€º á€¡á€•á€±á€«á€ºá€†á€¯á€¶á€¸á€á€”á€ºá€¸á€™á€¾á€¬ á€•á€¼á€á€•á€±á€¸á€á€Šá€º ğŸ‘†</span>
        </div>

        <button id="btnCreate" class="btn">
          âœ“ Create User
        </button>
      </div>

      <!-- Renew & Delete -->
      <div class="card">
        <h2>User Renew / Delete</h2>
        <small>á€›á€¾á€­á€•á€¼á€®á€¸á€á€¬á€¸ User á€á€½á€±á€€á€­á€¯ á€”á€±á€·á€‘á€•á€ºá€á€­á€¯á€¸ / á€–á€»á€€á€ºá€–á€­á€¯á€· á€¡á€á€¯á€¶á€¸á€•á€¼á€¯á€•á€«á‹</small>

        <label>Username (Renew)
          <input id="e_username" class="input" placeholder="eg. kp001" />
        </label>
        <label>Extra Days
          <input id="e_days" class="input" type="number" value="30" min="1" />
        </label>
        <button id="btnEdit" class="btn btn-secondary">
          âŸ³ Renew / Update
        </button>

        <hr style="border:none;border-top:1px solid #1f2937;margin:14px 0 10px;">

        <label>Username (Delete)
          <input id="d_username" class="input" placeholder="eg. kp001" />
        </label>
        <button id="btnDelete" class="btn btn-danger">
          âœ• Delete User
        </button>
      </div>
    </div>

    <!-- Middle row: Check user + User list -->
    <div class="row">
      <!-- Check user -->
      <div class="card" style="flex: 0.9 1 250px;">
        <h2>User á€›á€¾á€­/á€™á€›á€¾á€­ á€…á€…á€ºá€™á€šá€º</h2>
        <small>VPN App á€™á€¾á€¬á€œá€Šá€ºá€¸ á€’á€® endpoint á€€á€­á€¯á€á€¯á€¶á€¸á€‘á€¬á€¸á€á€šá€ºá‹</small>

        <label>Username
          <input id="q_username" class="input" placeholder="eg. kp001" />
        </label>
        <button id="btnCheck" class="btn btn-secondary">
          ? Check User
        </button>

        <pre id="userInfo" class="mono" style="margin-top:10px; font-size:12px; background:#020617; padding:8px; border-radius:8px; border:1px solid #1f2937; max-height:190px; overflow:auto;"></pre>
      </div>

      <!-- User list -->
      <div class="card" style="flex: 1.3 1 320px;">
        <div class="user-panel-header">
          <div>
            <h2>User List</h2>
            <small>á€”á€±á€¬á€€á€ºá€†á€¯á€¶á€¸ á€–á€”á€ºá€á€®á€¸á€‘á€¬á€¸á€á€±á€¬ User á€á€½á€±á€€á€­á€¯ á€¡á€•á€±á€«á€ºá€†á€¯á€¶á€¸á€€á€”á€± á€…á€¯á€‘á€¬á€¸á€‘á€¬á€¸á€•á€«á€á€šá€ºá‹</small>
          </div>
          <button id="btnList" class="btn btn-secondary" style="margin-top:0;">
            â†» Refresh
          </button>
        </div>

        <div class="filter-row">
          <input id="searchBox" class="input" placeholder="Username á€–á€¼á€„á€·á€ºá€›á€¾á€¬á€™á€šá€º..." />
          <span class="tag" id="summaryTag">Loadingâ€¦</span>
        </div>

        <div id="userList" class="user-table-wrapper">
          <div class="empty">User List á€•á€¼á€á€–á€­á€¯á€· Loading á€œá€¯á€•á€ºá€”á€±á€•á€«á€á€Šá€ºâ€¦</div>
        </div>
      </div>
    </div>
  </div>

  <script>
    const API_BASE = "https://admin.kpwork.qzz.io/kpvip";

    // ===== Admin Secret helpers =====
    function getAdminSecret() {
      return localStorage.getItem("ADMIN_SECRET") || "";
    }

    function setAdminSecret(secret) {
      localStorage.setItem("ADMIN_SECRET", secret);
    }

    function updateAdminStatus() {
      const el = document.getElementById("adminStatus");
      if (getAdminSecret()) {
        el.textContent = "âœ… Admin: Logged in";
      } else {
        el.textContent = "ğŸ”’ Admin: Locked";
      }
    }

    async function requireAdminSecret() {
      let secret = getAdminSecret();
      if (!secret) {
        secret = prompt("KP Admin Secret á€‘á€Šá€·á€ºá€•á€«");
        if (!secret) return null;
        secret = secret.trim();
        if (!secret) return null;
        setAdminSecret(secret);
      }
      updateAdminStatus();
      return secret;
    }

    document.getElementById("btnAdminSecret").onclick = async () => {
      const current = getAdminSecret();
      const s = prompt("KP Admin Secret á€‘á€Šá€·á€º/á€•á€¼á€”á€ºá€•á€¼á€„á€ºá€•á€«", current || "");
      if (!s) return;
      setAdminSecret(s.trim());
      updateAdminStatus();
      alert("Admin Secret á€á€­á€™á€ºá€¸á€•á€¼á€®á€¸á€•á€«á€•á€¼á€®");
    };

    // ===== Helper functions =====
    function toast(msg) {
      alert(msg);
    }

    function formatDate(ts) {
      if (!ts) return "-";
      try {
        return new Date(ts * 1000).toLocaleString();
      } catch {
        return "-";
      }
    }

    function daysLeft(expireAt) {
      if (!expireAt) return null;
      const now = Math.floor(Date.now() / 1000);
      const diff = expireAt - now;
      const d = Math.ceil(diff / 86400);
      return d;
    }

    async function postForm(path, bodyObj, needSecret = true) {
      const url = API_BASE + path;

      const headers = {
        "Content-Type": "application/x-www-form-urlencoded; charset=UTF-8"
      };

      if (needSecret) {
        const secret = await requireAdminSecret();
        if (!secret) {
          toast("Admin Secret á€™á€‘á€Šá€·á€ºá€œá€±á€¬á€· Panel á€€á€­á€¯á€á€¯á€¶á€¸á€œá€­á€¯á€· á€™á€›á€˜á€°á€¸");
          return null;
        }
        headers["x-admin-secret"] = secret;
      } else {
        const s = getAdminSecret();
        if (s) headers["x-admin-secret"] = s;
      }

      const res = await fetch(url, {
        method: "POST",
        headers,
        body: new URLSearchParams(bodyObj)
      });

      let data;
      try {
        data = await res.json();
      } catch (e) {
        data = { status: "error", message: "Invalid JSON", raw: await res.text() };
      }
      return data;
    }

    async function callList() {
      return await postForm("/list.php", {}, true);
    }

    // ===== User List Rendering =====
    let currentUsers = [];

    function renderUserTable(filterText = "") {
      const container = document.getElementById("userList");
      const summaryTag = document.getElementById("summaryTag");
      container.innerHTML = "";

      let users = [...currentUsers];

      users.sort((a, b) => (b.createdAt || 0) - (a.createdAt || 0));

      if (filterText) {
        const f = filterText.toLowerCase();
        users = users.filter(u => (u.username || "").toLowerCase().includes(f));
      }

      summaryTag.textContent = users.length
        ? `Total: ${users.length} user(s)`
        : "User á€™á€›á€¾á€­á€á€±á€¸á€˜á€°á€¸";

      if (!users.length) {
        const div = document.createElement("div");
        div.className = "empty";
        div.textContent = "User á€™á€á€½á€±á€·á€•á€«á‹";
        container.appendChild(div);
        return;
      }

      const table = document.createElement("table");
      const thead = document.createElement("thead");
      thead.innerHTML = `
        <tr>
          <th>Username</th>
          <th>Created</th>
          <th>Expire</th>
          <th>á€¡á€á€¼á€±á€¡á€”á€±</th>
        </tr>`;
      table.appendChild(thead);

      const tbody = document.createElement("tbody");

      for (const u of users) {
        const tr = document.createElement("tr");

        const d = daysLeft(u.expireAt || 0);
        const isExpired = d !== null && (isNaN(d) || d <= 0);

        const created = formatDate(u.createdAt);
        const expire = u.expireAt ? formatDate(u.expireAt) : "Not started";

        tr.innerHTML = `
          <td class="username-col mono">${u.username || "-"}</td>
          <td class="mono dim">${created}</td>
          <td class="mono dim">${expire}</td>
          <td></td>
        `;

        const statusTd = tr.lastElementChild;
        const chip = document.createElement("div");
        chip.className = "status-chip" + (isExpired ? " expired" : "");
        const dot = document.createElement("span");
        dot.className = "status-dot" + (isExpired ? " expired" : "");
        const text = document.createElement("span");

        if (!u.expireAt) {
          text.textContent = "Not started (no login)";
        } else if (isExpired) {
          text.textContent = "Expired";
        } else {
          text.textContent = `${d} day(s) left`;
        }

        chip.appendChild(dot);
        chip.appendChild(text);
        statusTd.appendChild(chip);

        tbody.appendChild(tr);
      }

      table.appendChild(tbody);
      container.appendChild(table);
    }

    async function refreshUserList() {
      const summaryTag = document.getElementById("summaryTag");
      summaryTag.textContent = "Loadingâ€¦";
      const data = await callList();
      if (!data || data.status !== "ok") {
        summaryTag.textContent = "Load fail";
        const container = document.getElementById("userList");
        container.innerHTML = "";
        const div = document.createElement("div");
        div.className = "empty";
        div.textContent = "User List load á€™á€¡á€±á€¬á€„á€ºá€™á€¼á€„á€ºá€•á€«: " + (data && data.message || "unknown");
        container.appendChild(div);
        return;
      }
      currentUsers = data.users || [];
      renderUserTable(document.getElementById("searchBox").value.trim());
    }

    // ===== Buttons =====
    document.getElementById("btnCreate").onclick = async () => {
      const username = document.getElementById("c_username").value.trim();
      const password = document.getElementById("c_password").value.trim();
      const days = document.getElementById("c_days").value.trim();

      if (!username || !password || !days) {
        toast("username / password / days á€á€¯á€¶á€¸á€á€¯á€œá€¯á€¶á€¸ á€–á€¼á€Šá€·á€ºá€•á€±á€¸á€•á€«");
        return;
      }

      const data = await postForm("/create.php", { username, password, days }, true);
      if (data && data.status === "ok") {
        toast("User á€–á€”á€ºá€á€®á€¸á€•á€¼á€®á€¸: " + username);
        const now = Math.floor(Date.now() / 1000);
        currentUsers.push({
          username,
          password,
          createdAt: now,
          // 1DV á€™á€…á€á€±á€¸á€œá€­á€¯á€· expireAt á€€á€­á€¯ null á€‘á€¬á€¸á€›á€”á€º
          expireAt: data.expireAt || null
        });
        renderUserTable(document.getElementById("searchBox").value.trim());
      } else if (data) {
        toast("Create Fail: " + (data.message || "unknown error"));
      } else {
        toast("Create Fail: Network error");
      }
    };

    document.getElementById("btnEdit").onclick = async () => {
      const username = document.getElementById("e_username").value.trim();
      const days = document.getElementById("e_days").value.trim();

      if (!username || !days) {
        toast("username / days á€–á€¼á€Šá€·á€ºá€•á€«");
        return;
      }

      const data = await postForm("/edit.php", { username, days }, true);
      if (data && data.status === "ok") {
        toast("User renewed: " + username);
        refreshUserList();
      } else if (data) {
        toast("Renew Fail: " + (data.message || "unknown error"));
      } else {
        toast("Renew Fail: Network error");
      }
    };

    document.getElementById("btnDelete").onclick = async () => {
      const username = document.getElementById("d_username").value.trim();
      if (!username) {
        toast("username á€–á€¼á€Šá€·á€ºá€•á€«");
        return;
      }
      const ok = confirm("User " + username + " á€€á€­á€¯ á€á€€á€šá€ºá€–á€»á€€á€ºá€™á€œá€¬á€¸?");
      if (!ok) return;

      const data = await postForm("/delete.php", { username }, true);
      if (data && data.status === "ok") {
        toast("User deleted: " + username);
        currentUsers = currentUsers.filter(u => u.username !== username);
        renderUserTable(document.getElementById("searchBox").value.trim());
      } else if (data) {
        toast("Delete Fail: " + (data.message || "unknown error"));
      } else {
        toast("Delete Fail: Network error");
      }
    };

    // user_exist.php -> admin header á€™á€œá€­á€¯á€•á€±á€™á€šá€·á€º á€›á€¾á€­á€›á€„á€º á€‘á€•á€ºá€•á€­á€¯á€·á€™á€šá€º
    document.getElementById("btnCheck").onclick = async () => {
      const username = document.getElementById("q_username").value.trim();
      if (!username) {
        toast("username á€–á€¼á€Šá€·á€ºá€•á€«");
        return;
      }
      const data = await postForm("/user_exist.php", { username }, false);
      const el = document.getElementById("userInfo");
      el.textContent = JSON.stringify(data, null, 2);
    };

    document.getElementById("btnList").onclick = async () => {
      await refreshUserList();
    };

    document.getElementById("searchBox").addEventListener("input", (e) => {
      renderUserTable(e.target.value.trim());
    });

    window.addEventListener("load", () => {
      updateAdminStatus();
      refreshUserList();
    });
  </script>
</body>
</html>
