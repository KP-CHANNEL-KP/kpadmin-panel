<!DOCTYPE html>
<html lang="my">
<head>
  <meta charset="UTF-8" />
  <title>KP VIP Admin</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root {
      --bg: #020617;
      --bg-card: #020617;
      --bg-card2: #020617;
      --border: #1f2937;
      --accent: #3b82f6;
      --accent-soft: rgba(59,130,246,0.2);
      --danger: #ef4444;
      --text: #e5e7eb;
      --text-soft: #9ca3af;
      --radius: 14px;
    }
    * { box-sizing: border-box; }
    body {
      margin: 0;
      padding: 20px 10px 32px;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: radial-gradient(circle at top, #0f172a 0, #020617 50%, #000 100%);
      color: var(--text);
      min-height: 100vh;
    }
    .shell {
      max-width: 980px;
      margin: 0 auto;
    }
    header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 10px;
      margin-bottom: 16px;
    }
    .title-block {
      display: flex;
      flex-direction: column;
      gap: 2px;
    }
    .title {
      font-size: 20px;
      font-weight: 600;
      letter-spacing: .04em;
    }
    .subtitle {
      font-size: 12px;
      color: var(--text-soft);
    }
    .badge {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      font-size: 11px;
      padding: 4px 8px;
      border-radius: 999px;
      background: rgba(34,197,94,0.08);
      color: #bbf7d0;
      border: 1px solid rgba(34,197,94,0.3);
      margin-top: 4px;
    }
    .badge span {
      display: inline-block;
      width: 6px;
      height: 6px;
      border-radius: 999px;
      background: #22c55e;
      box-shadow: 0 0 0 4px rgba(34,197,94,0.35);
    }

    /* Admin Secret bar */
    .secret-bar {
      display: flex;
      align-items: center;
      gap: 6px;
      background: rgba(15,23,42,0.9);
      border-radius: 999px;
      padding: 4px 8px 4px 10px;
      border: 1px solid var(--border);
      box-shadow: 0 0 0 1px rgba(15,23,42,0.6);
      backdrop-filter: blur(14px);
    }
    .secret-bar label {
      font-size: 11px;
      color: var(--text-soft);
      white-space: nowrap;
    }
    .secret-bar input {
      border: none;
      outline: none;
      font-size: 11px;
      padding: 5px 7px;
      min-width: 120px;
      border-radius: 999px;
      background: #020617;
      color: var(--text);
    }
    .secret-bar button {
      border-radius: 999px;
      border: none;
      font-size: 11px;
      padding: 5px 10px;
      background: var(--accent);
      color: white;
      cursor: pointer;
      white-space: nowrap;
    }
    .secret-status {
      font-size: 10px;
      color: var(--text-soft);
      white-space: nowrap;
    }

    main {
      display: grid;
      grid-template-columns: minmax(0,1.2fr) minmax(0,1.2fr);
      gap: 14px;
    }
    @media (max-width: 780px) {
      main { grid-template-columns: minmax(0,1fr); }
      header { flex-direction: column; align-items: flex-start; }
      .secret-bar { align-self: stretch; justify-content: flex-start; }
    }

    .card {
      background: linear-gradient(145deg, rgba(15,23,42,0.94), rgba(15,23,42,0.8));
      border-radius: var(--radius);
      padding: 14px 14px 16px;
      border: 1px solid rgba(31,41,55,0.9);
      box-shadow:
        0 18px 45px rgba(15,23,42,0.85),
        0 0 0 1px rgba(15,23,42,0.8);
    }
    .card h2 {
      margin: 0 0 4px;
      font-size: 14px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 6px;
    }
    .card small {
      font-size: 11px;
      color: var(--text-soft);
      display: block;
      margin-bottom: 8px;
    }
    .card-section {
      margin-top: 10px;
      padding-top: 10px;
      border-top: 1px dashed rgba(55,65,81,0.8);
    }
    label {
      display: block;
      font-size: 11px;
      color: var(--text-soft);
      margin-bottom: 3px;
    }
    input[type="text"],
    input[type="number"] {
      width: 100%;
      padding: 7px 8px;
      border-radius: 9px;
      border: 1px solid rgba(55,65,81,0.9);
      background: radial-gradient(circle at top left,#020617,#020617);
      color: var(--text);
      font-size: 12px;
      outline: none;
    }
    input::placeholder { color: #6b7280; }

    .field {
      margin-bottom: 8px;
    }

    .btn-row {
      display: flex;
      gap: 8px;
      margin-top: 4px;
    }
    button.primary {
      flex: 1;
      border-radius: 999px;
      border: none;
      padding: 7px 10px;
      font-size: 12px;
      background: linear-gradient(135deg,#2563eb,#3b82f6);
      color: white;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 6px;
    }
    button.secondary {
      flex: 1;
      border-radius: 999px;
      border: none;
      padding: 7px 10px;
      font-size: 12px;
      background: rgba(15,23,42,0.9);
      color: var(--text);
      border: 1px solid rgba(55,65,81,0.9);
      cursor: pointer;
    }
    button.danger {
      flex: 1;
      border-radius: 999px;
      border: none;
      padding: 7px 10px;
      font-size: 12px;
      background: linear-gradient(135deg,#b91c1c,#ef4444);
      color: white;
      cursor: pointer;
    }

    .helper {
      font-size: 11px;
      color: var(--text-soft);
      margin-top: 4px;
    }
    .helper strong {
      color: #f97316;
      font-weight: 500;
    }

    .muted {
      font-size: 11px;
      color: var(--text-soft);
    }

    .user-list {
      margin-top: 8px;
      background: rgba(15,23,42,0.9);
      border-radius: 10px;
      border: 1px solid rgba(31,41,55,0.9);
      max-height: 260px;
      overflow: auto;
      padding: 6px 6px 6px 0;
      font-size: 12px;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 12px;
    }
    th, td {
      text-align: left;
      padding: 4px 10px;
      border-bottom: 1px solid rgba(31,41,55,0.6);
      white-space: nowrap;
    }
    th {
      position: sticky;
      top: 0;
      background: rgba(15,23,42,0.98);
      font-weight: 500;
    }
    tr:last-child td { border-bottom: none; }
    .pill {
      display: inline-flex;
      padding: 2px 7px;
      border-radius: 999px;
      font-size: 10px;
      background: rgba(15,23,42,0.9);
      border: 1px solid rgba(55,65,81,0.9);
      color: var(--text-soft);
    }
    .pill.ok {
      background: rgba(22,163,74,0.12);
      border-color: rgba(22,163,74,0.5);
      color: #bbf7d0;
    }
    .pill.bad {
      background: rgba(185,28,28,0.08);
      border-color: rgba(239,68,68,0.6);
      color: #fecaca;
    }
    .status-chip {
      font-size: 11px;
      padding: 2px 8px;
      border-radius: 999px;
      background: rgba(15,23,42,0.9);
      border: 1px solid rgba(55,65,81,0.9);
      color: var(--text-soft);
    }
  </style>
</head>
<body>
  <div class="shell">
    <header>
      <div class="title-block">
        <div class="title">KP VIP Admin</div>
        <div class="subtitle">
          Username / Password တွေသတ်မှတ်ပြီး VIP User ကို Worker + KV နဲ့ စီမံချင်တဲ့ Panel
        </div>
        <div class="badge"><span></span> Worker + KV</div>
      </div>

      <div class="secret-bar">
        <label for="adminSecret">Admin Secret</label>
        <input id="adminSecret" type="password" placeholder="••••••••" />
        <button id="btnAdminSecret">Save</button>
        <div id="secretStatus" class="secret-status">not set</div>
      </div>
    </header>

    <main>
      <!-- Create -->
      <section class="card">
        <h2>အသစ် User ဖန်တီးမယ်</h2>
        <small>Username, Password, Expire Days သတ်မှတ်ပြီး VIP User အသစ်ဖန်တီးပါ။</small>

        <div class="field">
          <label for="c_username">Username</label>
          <input id="c_username" type="text" placeholder="eg. kp001" />
        </div>
        <div class="field">
          <label for="c_password">Password</label>
          <input id="c_password" type="text" placeholder="eg. 123456" />
        </div>
        <div class="field">
          <label for="c_days">Days (Expire အထိ)</label>
          <input id="c_days" type="number" value="30" min="1" />
        </div>
        <div class="btn-row">
          <button class="primary" id="btnCreate">● Create User</button>
        </div>
        <p class="helper">
          ✔ User ဖန်တီးပြီးရင် အောက်က <strong>User List</strong> ရဲ့ ပထမဆုံး row မှာ တွေ့ရပါမယ်။
        </p>
      </section>

      <!-- Renew / Delete -->
      <section class="card">
        <h2>User Renew / Delete</h2>
        <small>ရှိပြီးသား User တွေကို နေ့ထပ်တိုး / ဖျက်ဖို့ အပိုင်း</small>

        <div class="card-section">
          <div class="field">
            <label for="e_username">Username (Renew)</label>
            <input id="e_username" type="text" placeholder="eg. kp001" />
          </div>
          <div class="field">
            <label for="e_days">Extra Days</label>
            <input id="e_days" type="number" value="30" min="1" />
          </div>
          <div class="btn-row">
            <button class="secondary" id="btnEdit">↻ Renew / Update</button>
          </div>
        </div>

        <div class="card-section">
          <div class="field">
            <label for="d_username">Username (Delete)</label>
            <input id="d_username" type="text" placeholder="eg. kp001" />
          </div>
          <div class="btn-row">
            <button class="danger" id="btnDelete">✕ Delete User</button>
          </div>
        </div>
      </section>

      <!-- Check -->
      <section class="card">
        <h2>User ရှိ/မရှိ စစ်မယ်</h2>
        <small>VPN App တစ်ဖက်က သုံးမဲ့ endpoint နဲ့ တူအောင် ဆောက်ထားပါတယ်။</small>

        <div class="field">
          <label for="q_username">Username</label>
          <input id="q_username" type="text" placeholder="eg. kp001" />
        </div>
        <div class="btn-row">
          <button class="secondary" id="btnCheck">? Check User</button>
        </div>

        <p id="userInfo" class="helper muted" style="margin-top:8px;">Result မရှိသေးပါ...</p>
      </section>

      <!-- User List -->
      <section class="card">
        <h2>
          User List
          <span class="status-chip">
            <span id="listStatus">Idle</span>
          </span>
        </h2>
        <small>အောက်မှာ မိမိ Worker + KV ထဲရှိပြီးသား User အားလုံးကို ကြည့်လို့ရပါတယ်။</small>

        <div class="btn-row" style="margin-bottom:4px;">
          <button class="secondary" id="btnList">⟳ Refresh</button>
        </div>
        <div id="userList" class="user-list">
          <div class="muted" style="padding:6px 10px;">
            User List load မလုပ်ရသေးပါ။
          </div>
        </div>
      </section>
    </main>
  </div>

  <script>
    const API_BASE = "https://vpnadmin.kpwork.qzz.io/kpvip";

    const secretInput = document.getElementById("adminSecret");
    const secretStatus = document.getElementById("secretStatus");

    function getAdminSecret() {
      return localStorage.getItem("ADMIN_SECRET") || "";
    }

    function saveAdminSecret(secret) {
      localStorage.setItem("ADMIN_SECRET", secret);
    }

    function updateSecretStatus() {
      const s = getAdminSecret();
      if (!s) {
        secretStatus.textContent = "not set";
      } else {
        secretStatus.textContent = "saved";
      }
    }

    document.getElementById("btnAdminSecret").onclick = () => {
      const secret = secretInput.value.trim();
      if (!secret) {
        alert("Secret မထည့်ရသေးပါ");
        return;
      }
      saveAdminSecret(secret);
      updateSecretStatus();
      alert("Admin Secret ကို သိမ်းထားပြီးပါပြီ ✔");
    };

    async function apiPost(path, body, requireAdmin = true) {
      const url = API_BASE + path;
      const headers = {
        "Content-Type": "application/x-www-form-urlencoded; charset=UTF-8",
      };
      const secret = getAdminSecret();

      if (requireAdmin) {
        if (!secret) {
          alert("Admin Secret မသတ်ထားသေးဘူး");
          return null;
        }
        headers["x-admin-secret"] = secret;
      } else {
        if (secret) headers["x-admin-secret"] = secret;
      }

      const res = await fetch(url, {
        method: "POST",
        headers,
        body: new URLSearchParams(body),
      });

      let data;
      try {
        data = await res.json();
      } catch (e) {
        data = { status: "error", message: "Invalid JSON", raw: await res.text() };
      }
      return data;
    }

    // Create user
    document.getElementById("btnCreate").onclick = async () => {
      const username = document.getElementById("c_username").value.trim();
      const password = document.getElementById("c_password").value.trim();
      const days = document.getElementById("c_days").value.trim();

      if (!username || !password || !days) {
        alert("username / password / days သုံးခုလုံး ဖြည့်ပေးပါ");
        return;
      }

      const data = await apiPost("/create.php", { username, password, days });
      if (!data) return;

      if (data.status === "ok") {
        alert("User ဖန်တီးပြီး: " + username);
        loadUsers(); // auto refresh
      } else {
        alert("Create Fail: " + (data.message || "unknown error"));
      }
    };

    // Renew user
    document.getElementById("btnEdit").onclick = async () => {
      const username = document.getElementById("e_username").value.trim();
      const days = document.getElementById("e_days").value.trim();
      if (!username || !days) {
        alert("username / days ဖြည့်ပါ");
        return;
      }
      const data = await apiPost("/edit.php", { username, days });
      if (!data) return;

      if (data.status === "ok") {
        alert("User renewed: " + username);
        loadUsers();
      } else {
        alert("Renew Fail: " + (data.message || "unknown error"));
      }
    };

    // Delete user
    document.getElementById("btnDelete").onclick = async () => {
      const username = document.getElementById("d_username").value.trim();
      if (!username) {
        alert("username ဖြည့်ပါ");
        return;
      }
      if (!confirm("User " + username + " ကို တကယ်ဖျက်မလား?")) return;

      const data = await apiPost("/delete.php", { username });
      if (!data) return;

      if (data.status === "ok") {
        alert("User deleted: " + username);
        loadUsers();
      } else {
        alert("Delete Fail: " + (data.message || "unknown error"));
      }
    };

    // Check user (user_exist.php, admin header မလို)
    document.getElementById("btnCheck").onclick = async () => {
      const username = document.getElementById("q_username").value.trim();
      if (!username) {
        alert("username ဖြည့်ပါ");
        return;
      }
      const data = await apiPost("/user_exist.php", { username }, false);
      const el = document.getElementById("userInfo");

      el.textContent = JSON.stringify(data, null, 2);
    };

    async function loadUsers() {
      const listStatus = document.getElementById("listStatus");
      const container = document.getElementById("userList");
      listStatus.textContent = "Loading…";

      const data = await apiPost("/list.php", {}, true);
      if (!data) {
        listStatus.textContent = "Error";
        return;
      }

      if (data.status !== "ok") {
        listStatus.textContent = "Unauthorized";
        container.innerHTML =
          '<div class="muted" style="padding:6px 10px;">User List load မအောင်မြင်ပါ: ' +
          (data.message || "") +
          "</div>";
        return;
      }

      const users = data.users || [];
      listStatus.textContent = users.length + " users";

      if (!users.length) {
        container.innerHTML =
          '<div class="muted" style="padding:6px 10px;">User မရှိသေးပါ...</div>';
        return;
      }

      users.sort((a, b) => (b.createdAt || 0) - (a.createdAt || 0));

      const rows = users
        .map(u => {
          const created = u.createdAt
            ? new Date(u.createdAt * 1000).toLocaleString()
            : "-";
          const expire = u.expireAt
            ? new Date(u.expireAt * 1000).toLocaleString()
            : "-";
          const now = Date.now() / 1000;
          const ok = u.expireAt && now < u.expireAt;
          const pillClass = ok ? "pill ok" : "pill bad";
          const pillText = ok ? "Active" : "Expired";
          return `
          <tr>
            <td>${u.username}</td>
            <td>${created}</td>
            <td>${expire}</td>
            <td><span class="${pillClass}">${pillText}</span></td>
          </tr>`;
        })
        .join("");

      container.innerHTML = `
        <table>
          <thead>
            <tr>
              <th>Username</th>
              <th>Created</th>
              <th>Expire</th>
              <th>Status</th>
            </tr>
          </thead>
          <tbody>${rows}</tbody>
        </table>`;
    }

    document.getElementById("btnList").onclick = loadUsers;

    window.addEventListener("load", () => {
      const s = getAdminSecret();
      if (s) {
        secretInput.value = s;
      }
      updateSecretStatus();
    });
  </script>
</body>
</html>
